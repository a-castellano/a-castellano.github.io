<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://a-castellano.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://a-castellano.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://a-castellano.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://a-castellano.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://a-castellano.github.io/css/light.css' />
    <link rel="stylesheet" href='https://a-castellano.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://a-castellano.github.io/css/syntax.css' />
    <title>Restrict Linux users to certain workspaces  - Álvaro Castellano - Personal Blog</title>
    
    <link rel="icon" type="image/x-icon" href='https://a-castellano.github.io/images/favicon.ico'>
    
    <meta name="theme-color" content="#1e2327">

    
    

    
    <meta name="description"
  content="How I solved the problem of restricting developer access to specific workspaces using chroot and Linux ACLs, preventing users from accessing files outside their designated directories." />
<meta name="keywords"
  content='' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://a-castellano.github.io/post/restrict-linux-users-to-certain-workspaces-only/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Restrict Linux users to certain workspaces  - Álvaro Castellano - Personal Blog" />
<meta name="twitter:description"
  content="How I solved the problem of restricting developer access to specific workspaces using chroot and Linux ACLs, preventing users from accessing files outside their designated directories." />
<meta name="twitter:site" content="https://a-castellano.github.io/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://a-castellano.github.io/">


<meta property="og:type" content="article" />
<meta property="og:title" content="Restrict Linux users to certain workspaces  - Álvaro Castellano - Personal Blog">
<meta property="og:description"
  content="How I solved the problem of restricting developer access to specific workspaces using chroot and Linux ACLs, preventing users from accessing files outside their designated directories." />
<meta property="og:url" content="https://a-castellano.github.io/post/restrict-linux-users-to-certain-workspaces-only/" />
<meta property="og:site_name" content="Restrict Linux users to certain workspaces " />
<meta property="og:image"
  content="https://a-castellano.github.io/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2016-09-22 21:15:07 &#43;0200 &#43;0200" />











</head>


<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://a-castellano.github.io/">
        <img class="octicon" height="32" width="32" src="">
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd" d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://a-castellano.github.io/">
            </label>
          </form>
          
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://a-castellano.github.io/">
        <img class="octicon octicon-mark-github v-align-middle" height="32" width="32" src="">
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>

  <div id="search-result" class="container-lg px-3 new-discussion-timeline" style="display: none;">
</div>

  
<div class="application-main">
  <div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://a-castellano.github.io/">
                  <img class=" avatar-user"
                    src="https://avatars0.githubusercontent.com/u/11519707?s=460&amp;u=c9ea059a83c4ea6f9daddec4fff28b1afacbe85a&amp;v=4"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://a-castellano.github.io/">Álvaro Castellano</a>
                  </span>
                  <span class="path-divider">/</span>
                  <strong class="css-truncate css-truncate-target mr-1" style="max-width: 410px">
                    <a href="https://a-castellano.github.io/post/restrict-linux-users-to-certain-workspaces-only/">Restrict Linux users to certain workspaces </a>
                  </strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Thu, 22 Sep 2016 21:15:07 &#43;0200"
                    class="no-wrap">
                    Thu, 22 Sep 2016 21:15:07 &#43;0200</relative-time>

                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      1587 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><p>In this post I will talk about managing workspace access for certain users in Linux environments. We will set a workspace where some guests will be able to work in their amazing project. These users won&rsquo;t have access to the files outside of their shared workspace. Finally we will use Linux ACL to manage user permissions inside their workspace.</p>
<p>This post resolves a real issue that I had few days ago. I was asked to restrict access to a couple users in a server. At the time I had no idea how to solve this issue in a smart way.</p>
<h2 id="problem-overview">Problem overview</h2>
<p>I need to allow a new user who is developing a new website into our development environment machine.</p>
<p>Doing this is very easy, we only need to create a user in our server… but here comes the problem, this user would be able to see other users&rsquo; home folders, config folders, etc.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh developerguest1@IP_ADDRESS_OF_OUR_TEST_MACHINE
</span></span><span style="display:flex;"><span>$ cd /home/john/
</span></span><span style="display:flex;"><span>$ ls
</span></span><span style="display:flex;"><span>john_files
</span></span><span style="display:flex;"><span>$ rsync -aP john_files SOMEWHERE
</span></span><span style="display:flex;"><span>$ cd /etc/apache2/sites-enabled/
</span></span></code></pre></div><p><img src="/images/restrict-users-non-restrict.png" alt="developerguest1 is able to read the server configurations"></p>
<p>I don&rsquo;t trust neither <em>developerguest1</em> nor his brother in arms <em>developerguest2</em>.
I want to isolate their workspace from my entire server.
Both developers will be able to work in their work directories but they won&rsquo;t be able to know what is outside those directories.
In this real case both developers will share their workspace but some folders will be owned only by one of them.</p>
<p>Let&rsquo;s do it!</p>
<h2 id="setting-up-our-workspace">Setting up our workspace</h2>
<p>In this post we will use <strong>Vagrant</strong> to deploy our test server, it allows us to deploy development environments in minutes.
We can deploy our environments to multiple providers such as <strong>VirtualBox</strong>, <strong>VMware Fusion</strong> or <strong>AWS</strong>.
See the <a href="https://www.vagrantup.com/docs/">Official documentation</a> for more info.
In my case, I use Vagrant to make quick tests with Virtual Machines before deploying my configurations into production environments.
Of course, you can use any other type of virtual machine or physical machines, as you wish.</p>
<p>Let&rsquo;s start cloning my <a href="https://github.com/a-castellano/Sysadmin-Scripts">Sysadmin Scripts</a> repo which contains the <strong>Vagrantfile</strong> that we will use.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/a-castellano/Sysadmin-Scripts.git
</span></span><span style="display:flex;"><span>cd Sysadmin-Scripts/Vagrant/Ubuntu_14
</span></span><span style="display:flex;"><span>cp bootstrap.sh.example bootstrap.sh
</span></span><span style="display:flex;"><span>vim bootstrap.sh
</span></span></code></pre></div><p>Add your ssh public key in your local copy.</p>
<pre tabindex="0"><code>#!/usr/bin/env bash

#Make a copy of this file called bootstrap-ansible.sh
#Set your ssh key, it would be your master_key.pub
mkdir -p /root/.ssh
echo &#34;YOUR PUBLIC SSH KEY&#34; &gt;&gt; /root/.ssh/authorized_keys
apt-get update -y
apt-get upgrade -y
</code></pre><p>Let&rsquo;s awaken our machine.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>⇒  vagrant up
</span></span><span style="display:flex;"><span>Bringing machine <span style="color:#e6db74">&#39;ubuntu1&#39;</span> up with <span style="color:#e6db74">&#39;virtualbox&#39;</span> provider...
</span></span><span style="display:flex;"><span><span style="color:#f92672">==</span>&gt; ubuntu1: Importing base box <span style="color:#e6db74">&#39;ubuntu/trusty64&#39;</span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">==</span>&gt; ubuntu1: Matching MAC address <span style="color:#66d9ef">for</span> NAT networking...
</span></span><span style="display:flex;"><span><span style="color:#f92672">==</span>&gt; ubuntu1: Checking <span style="color:#66d9ef">if</span> box <span style="color:#e6db74">&#39;ubuntu/trusty64&#39;</span> is up to date...
</span></span><span style="display:flex;"><span><span style="color:#f92672">==</span>&gt; ubuntu1: Setting the name of the VM: Ubuntu_14_ubuntu1_1474577586167_25708
</span></span><span style="display:flex;"><span><span style="color:#f92672">==</span>&gt; ubuntu1: Clearing any previously set forwarded ports...
</span></span><span style="display:flex;"><span><span style="color:#f92672">==</span>&gt; ubuntu1: Clearing any previously set network interfaces...
</span></span><span style="display:flex;"><span><span style="color:#f92672">==</span>&gt; ubuntu1: Available bridged network interfaces:
</span></span><span style="display:flex;"><span>1<span style="color:#f92672">)</span> en3: Ethernet Thunderbolt
</span></span><span style="display:flex;"><span>2<span style="color:#f92672">)</span> en0: Wi-Fi <span style="color:#f92672">(</span>AirPort<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>3<span style="color:#f92672">)</span> en1: Thunderbolt <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>4<span style="color:#f92672">)</span> en2: Thunderbolt <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>5<span style="color:#f92672">)</span> bridge0
</span></span><span style="display:flex;"><span>6<span style="color:#f92672">)</span> bridge100
</span></span><span style="display:flex;"><span><span style="color:#f92672">==</span>&gt; ubuntu1: When choosing an interface, it is usually the one that is
</span></span><span style="display:flex;"><span><span style="color:#f92672">==</span>&gt; ubuntu1: being used to connect to the internet.
</span></span><span style="display:flex;"><span>    ubuntu1: Which interface should the network bridge to? <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>When Vagrant ends it will show us our new machine IP address, let&rsquo;s write it in our inventory file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd ~/Sysadmin-Scripts/Ansible
</span></span><span style="display:flex;"><span>vim inventory/my.hosts
</span></span></code></pre></div><p>Place your Vagrant IP address in your inventory file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>testMine<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>192.168.*.*
</span></span></code></pre></div><p>Now, let&rsquo;s create the playbook to setup our environment.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir playbooks/setup_test
</span></span><span style="display:flex;"><span>vim playbooks/setup_test/setup.yml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">testMine</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">vars_files</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">../../vars/target_hosts/testMine.yml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">roles</span>:
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">role</span>: <span style="color:#ae81ff">../../roles/common_setup }</span>
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">role</span>: <span style="color:#ae81ff">../../roles/zsh_setup }</span>
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">role</span>: <span style="color:#ae81ff">../../roles/apache_setup }</span>
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">role</span>: <span style="color:#ae81ff">../../roles/php_setup }</span>
</span></span><span style="display:flex;"><span>      - { <span style="color:#f92672">role</span>: <span style="color:#ae81ff">../../roles/create_user }</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Our playbook needs another file containing the config of our test machine.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vim vars/target_hosts/testMine.yml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">server_hostname</span>: <span style="color:#ae81ff">Test</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">usergroups</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">developers</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">users</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">username</span>: <span style="color:#ae81ff">john</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">groups</span>: [<span style="color:#e6db74">&#39;users&#39;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">home</span>: <span style="color:#ae81ff">/home/john</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">password</span>: <span style="color:#ae81ff">$1$SomeSalt$/jbIwfYCu0MxPBND2EtRH.</span> <span style="color:#75715e">#password</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">username</span>: <span style="color:#ae81ff">cassandra</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">groups</span>: [<span style="color:#e6db74">&#39;users&#39;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">home</span>: <span style="color:#ae81ff">/home/cassandra</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">password</span>: <span style="color:#ae81ff">$1$SomeSalt$/jbIwfYCu0MxPBND2EtRH.</span> <span style="color:#75715e">#password</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">username</span>: <span style="color:#ae81ff">developerguest1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">group</span>: <span style="color:#ae81ff">users</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">groups</span>: [<span style="color:#e6db74">&#39;developers&#39;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">home</span>: <span style="color:#ae81ff">/var/www/developers</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">password</span>: <span style="color:#ae81ff">$1$SomeSalt$/jbIwfYCu0MxPBND2EtRH.</span> <span style="color:#75715e">#password</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">shell</span>: <span style="color:#ae81ff">/bin/false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">username</span>: <span style="color:#ae81ff">developerguest2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">group</span>: <span style="color:#ae81ff">users</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">groups</span>: [<span style="color:#e6db74">&#39;developers&#39;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">home</span>: <span style="color:#ae81ff">/var/www/developers</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">password</span>: <span style="color:#ae81ff">$1$SomeSalt$/jbIwfYCu0MxPBND2EtRH.</span> <span style="color:#75715e">#password</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">shell</span>: <span style="color:#ae81ff">/bin/false</span>
</span></span></code></pre></div><p>So, Ansible will create four users: two common users called John and Cassandra and two developers which won&rsquo;t be able to log into our server using ssh.
The password for all users is &ldquo;password&rdquo;.</p>
<p>Let&rsquo;s configure our server:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible-playbook playbooks/setup_test_mine/setup.yml
</span></span></code></pre></div><p>After deploying our configurations let&rsquo;s enter inside our vagrant machine.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd Sysadmin-Scripts/Vagrant/Ubuntu_14
</span></span><span style="display:flex;"><span>vagrant ssh
</span></span></code></pre></div><p>We will start copying our testing websites in our test machine.
The script <strong>configure.sh</strong> also changes the apache2 conf allowing access on <strong>/var/developers</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo su
</span></span><span style="display:flex;"><span>cd
</span></span><span style="display:flex;"><span>git clone https://github.com/a-castellano/acl-post-websites.git
</span></span><span style="display:flex;"><span>cd acl-post-websites
</span></span><span style="display:flex;"><span>./configure.sh
</span></span><span style="display:flex;"><span>ls /var/developers
</span></span><span style="display:flex;"><span>developerguest1_website  developerguest2_website  developers_website
</span></span></code></pre></div><p>Now we are going to jail the <em>developers</em> users inside <strong>/var/www/developers</strong>.
In order to do this we have to modify our ssh server config, edit <strong>/etc/ssh/sshd_config</strong>, modify this file as follows:</p>
<pre tabindex="0"><code>Port 22
Protocol 2

HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_dsa_key
HostKey /etc/ssh/ssh_host_ecdsa_key
HostKey /etc/ssh/ssh_host_ed25519_key
UsePrivilegeSeparation yes

KeyRegenerationInterval 3600
ServerKeyBits 1024

SyslogFacility AUTH
LogLevel INFO

LoginGraceTime 120
PermitRootLogin without-password
StrictModes yes

RSAAuthentication yes
PubkeyAuthentication yes

IgnoreRhosts yes

RhostsRSAAuthentication no

HostbasedAuthentication no

PermitEmptyPasswords no

ChallengeResponseAuthentication no

PasswordAuthentication yes

X11Forwarding yes
X11DisplayOffset 10
PrintMotd no
PrintLastLog yes
TCPKeepAlive yes

AcceptEnv LANG LC_*

#Subsystem sftp /usr/lib/openssh/sftp-server
Subsystem sftp internal-sftp
UsePAM yes
Match group developers
    ChrootDirectory /var/developers
    ForceCommand internal-sftp
    AllowTCPForwarding no
    X11Forwarding no
</code></pre><p>Restart the ssh server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>service ssh restart
</span></span></code></pre></div><p>And change the jailed folder ownership and permissions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chown root:root /var/developers
</span></span><span style="display:flex;"><span>chmod go-w /var/developers
</span></span></code></pre></div><p>In <strong>/etc/apache2/apache2.conf</strong> we need to add the <strong>/var/developers</strong> folder for giving apache2 access to this folder.</p>
<h2 id="testing-the-jail">Testing the jail</h2>
<p><img src="/images/restrict-users-restricted.png" alt="developerguest1 is jailed inside /var/developers"></p>
<p>We did it!
<strong>developerguest1</strong> and <strong>developerguest2</strong> are jailed inside <strong>/var/developers</strong> and they can&rsquo;t go outside this folder.
The problem is solved.</p>
<h2 id="going-beyond-using-acl">Going beyond, using ACL</h2>
<p>Finally let&rsquo;s suppose that now we want to block <strong>developerguest1</strong> from accessing <strong>developerguest2_website</strong> folder.
Of course we could create a jailed folder for each user to resolve this issue but in this case we are going tu use <strong>Linux ACL</strong>.</p>
<p>Access Control List (ACL) provides an additional, more flexible permission mechanism for file systems.
It is designed to assist with UNIX file permissions.
ACL allows you to give permissions for any user or group to any disk resource.</p>
<p>So, what are we going to do?</p>
<p>We will change the ownership of <strong>/var/developers</strong> sub folders to <strong>www-data</strong>, the permission will be 770 therefore our developers won&rsquo;t be able to look into their own folders.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /var/developers
</span></span><span style="display:flex;"><span>chown -R www-data. developerguest1_website  developerguest2_website  developers_website
</span></span><span style="display:flex;"><span>chmod -R <span style="color:#ae81ff">770</span> developerguest1_website  developerguest2_website  developers_website
</span></span></code></pre></div><p>After doing this the developers can&rsquo;t access to their own directories.</p>
<p><img src="/images/acl-developer-has-no-permissions.png" alt="Developers have no access"></p>
<p>Using ACL we are going to give developerguest1 permissions to work inside developerguest1_website and developers_website folders.
We will do the same for developerguest2.</p>
<p><strong>Enabling ACL</strong></p>
<p>By default, ACL is enabled in Ubuntu14 but we need to enable it in our disk partition.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vim /etc/fstab
</span></span></code></pre></div><p>We need to modify our disk partition settings from this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>LABEL<span style="color:#f92672">=</span>cloudimg-rootfs   /        ext4   defaults        <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>To this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>LABEL<span style="color:#f92672">=</span>cloudimg-rootfs   /        ext4   defaults,acl    <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>We must <strong>reboot</strong> our vagrant machine.</p>
<p>Let&rsquo;s review which commands we are going to use:
<strong>getfacl</strong>: to review permissions.
<strong>setfacl</strong>: the acl version of chmod.</p>
<p>Let&rsquo;s go <strong>/var/developers</strong> and give <strong>developerguest1</strong> rights to /var/developers/developerguest1_website</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /var/developers
</span></span><span style="display:flex;"><span>getfacl /var/developers/developerguest1_website
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># file: /var/developers/developerguest1_website</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># owner: www-data</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># group: www-data</span>
</span></span><span style="display:flex;"><span>user::rwx
</span></span><span style="display:flex;"><span>group::rwx
</span></span><span style="display:flex;"><span>other::---
</span></span></code></pre></div><p>By default, the folder is owned by www-data as we set before.
Using ACL&rsquo;s we are going to configure a new file creation behaviour, for each new file created by our developers, it will have read and execution permission by default.
We do this because if developerguest1 creates a file, www-data won&rsquo;t be able to read it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>setfacl -R -d -m  g::rwx /var/developers/developerguest1_website
</span></span><span style="display:flex;"><span>setfacl -R -d -m  o::rx /var/developers/developerguest1_website
</span></span><span style="display:flex;"><span>getfacl /var/developers/developerguest1_website
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># file: /var/developers/developerguest1_website</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># owner: www-data</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># group: www-data</span>
</span></span><span style="display:flex;"><span>user::rwx
</span></span><span style="display:flex;"><span>group::rwx
</span></span><span style="display:flex;"><span>other::---
</span></span><span style="display:flex;"><span>default:user::rwx
</span></span><span style="display:flex;"><span>default:group::rwx
</span></span><span style="display:flex;"><span>default:other::r-x
</span></span></code></pre></div><p>Wait, what are these <strong>setfacl</strong> options? Let&rsquo;s see them:
<strong>-R</strong>: recurse into subdirectories
<strong>-d</strong>: operations apply to the default ACL
<strong>-m</strong>: modify the current ACL(s) of file(s)</p>
<p>Let&rsquo;s give <strong>developerguest1</strong> permissions in his folder.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>setfacl -Rm u:developerguest1:rwx /var/developers/developerguest1_website
</span></span><span style="display:flex;"><span>getfacl /var/developers/developerguest1_website
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># file: /var/developers/developerguest1_website</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># owner: www-data</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># group: www-data</span>
</span></span><span style="display:flex;"><span>user::rwx
</span></span><span style="display:flex;"><span>user:developerguest1:rwx
</span></span><span style="display:flex;"><span>group::rwx
</span></span><span style="display:flex;"><span>mask::rwx
</span></span><span style="display:flex;"><span>other::---
</span></span><span style="display:flex;"><span>default:user::rwx
</span></span><span style="display:flex;"><span>default:group::rwx
</span></span><span style="display:flex;"><span>default:other::r-x
</span></span></code></pre></div><p>Now <strong>developerguest1</strong> is able to access to access to <strong>developerguest1_website</strong> and modify it.</p>
<p><img src="/images/acl-developerguest1-has-access.png" alt="Now, developerguest1 has access"></p>
<p>So, <strong>developerguest1</strong> can change and create files that <strong>www-data</strong> can read, make some tests.</p>
<p>Let&rsquo;s do the same with <strong>developerguest2</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>setfacl -R -d -m  g::rwx /var/developers/developerguest2_website
</span></span><span style="display:flex;"><span>setfacl -R -d -m  o::rx /var/developers/developerguest2_website
</span></span><span style="display:flex;"><span>setfacl -Rm u:developerguest2:rwx /var/developers/developerguest2_website
</span></span><span style="display:flex;"><span>getfacl /var/developers/developerguest2_website
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># file: /var/developers/developerguest2_website</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># owner: www-data</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># group: www-data</span>
</span></span><span style="display:flex;"><span>user::rwx
</span></span><span style="display:flex;"><span>user:developerguest2:rwx
</span></span><span style="display:flex;"><span>group::rwx
</span></span><span style="display:flex;"><span>mask::rwx
</span></span><span style="display:flex;"><span>other::---
</span></span><span style="display:flex;"><span>default:user::rwx
</span></span><span style="display:flex;"><span>default:group::rwx
</span></span><span style="display:flex;"><span>default:other::r-x
</span></span></code></pre></div><p>Finally, we can assign access to developers group on <strong>developers_website</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>setfacl -R -d -m  g::rwx /var/developers/developers_website
</span></span><span style="display:flex;"><span>setfacl -R -d -m  o::rwx /var/developers/developers_website
</span></span><span style="display:flex;"><span>setfacl -Rm u:developerguest1:rwx /var/developers/developers_website
</span></span><span style="display:flex;"><span>setfacl -Rm u:developerguest2:rwx /var/developers/developers_website
</span></span><span style="display:flex;"><span>getfacl /var/developers/developers_website
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># file: /var/developers/developers_website</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># owner: www-data</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># group: www-data</span>
</span></span><span style="display:flex;"><span>user::rwx
</span></span><span style="display:flex;"><span>user:developerguest1:rwx
</span></span><span style="display:flex;"><span>user:developerguest2:rwx
</span></span><span style="display:flex;"><span>group::rwx
</span></span><span style="display:flex;"><span>mask::rwx
</span></span><span style="display:flex;"><span>other::---
</span></span><span style="display:flex;"><span>default:user::rwx
</span></span><span style="display:flex;"><span>default:group::rwx
</span></span><span style="display:flex;"><span>default:other::rwx
</span></span></code></pre></div><p>So for any guest developer we create we will need to modify the ACL, isn&rsquo;t?
Well, it is not necessary, we can use ACL&rsquo;s with groups too.</p>
<p>First, let&rsquo;s delete the current rules over <strong>developers_website</strong>.
We are going to use <strong>-b</strong> option to delete all ACL rules.
There are many other options that we can use, see <a href="https://linux.die.net/man/1/setfacl">setfacl man page</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>setfacl -b /var/developers/developers_website
</span></span><span style="display:flex;"><span>setfacl -R -d -m  g::rwx /var/developers/developers_website
</span></span><span style="display:flex;"><span>setfacl -R -d -m  o::rwx /var/developers/developers_website
</span></span><span style="display:flex;"><span>setfacl -Rm g:developers:rwx /var/developers/developers_website
</span></span><span style="display:flex;"><span>getfacl /var/developers/developers_website
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># file: var/developers/developers_website</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># owner: www-data</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># group: www-data</span>
</span></span><span style="display:flex;"><span>user::rwx
</span></span><span style="display:flex;"><span>group::rwx
</span></span><span style="display:flex;"><span>group:developers:rwx
</span></span><span style="display:flex;"><span>mask::rwx
</span></span><span style="display:flex;"><span>other::---
</span></span><span style="display:flex;"><span>default:user::rwx
</span></span><span style="display:flex;"><span>default:group::rwx
</span></span><span style="display:flex;"><span>default:other::rwx
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>We have learned how to restrict access to some users and manage these access using ACL&rsquo;s.
There are many more things that we can do with ACL&rsquo;s, this is only a silly example.
I hope that you will find this post useful.
Stay tuned for new posts.</p>
</article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://a-castellano.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://a-castellano.github.io/css/toc.css' />

  
</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://a-castellano.github.io/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
      <li class="mr-3 mr-lg-0">GitHub and the Invertocat logo are trademarks of <a href="https://github.com/">GitHub, Inc.</a></li>
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>

</body>

<script type="application/javascript" src="https://a-castellano.github.io/js/github-style.js"></script>







</html>