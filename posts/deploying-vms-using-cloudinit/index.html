<!doctype html><html lang=en-us><head><meta charset=utf-8><link crossorigin=anonymous media=all rel=stylesheet href=https://a-castellano.github.io/css/frameworks.css><link crossorigin=anonymous media=all rel=stylesheet href=https://a-castellano.github.io/css/github.css><link crossorigin=anonymous media="(prefers-color-scheme: dark)" rel=stylesheet href=https://a-castellano.github.io/css/dark.css><meta name=viewport content="width=device-width"><title>Deploying VM's using Cloud-init - Álvaro Castellano - Personal Blog</title><link rel=icon type=image/x-icon class=js-site-favicon href=https://a-castellano.github.io/images/favicon.ico><meta name=theme-color content="#1e2327"></head><body class="env-production emoji-size-boost page-responsive page-profile"><div class="position-relative js-header-wrapper"><span class="Progress progress-pjax-loader position-fixed width-full js-pjax-loader-bar"><span class="progress-pjax-loader-bar top-0 left-0" style=width:0%></span></span><header class="Header py-lg-0 js-details-container Details flex-wrap flex-lg-nowrap p-responsive" role=banner><div class="Header-item d-none d-lg-flex"><a class=Header-link href=https://a-castellano.github.io/ aria-label=Homepage data-ga-click="Header, go to dashboard, icon:logo"><svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div><div class="Header-item Header-item--full flex-column flex-lg-row width-full flex-order-2 flex-lg-order-none mr-0 mr-lg-3 mt-3 mt-lg-0 Details-content--hidden"><div class="header-search flex-self-stretch flex-lg-self-auto mr-0 mr-lg-3 mb-3 mb-lg-0 scoped-search site-scoped-search js-site-search position-relative js-jump-to" role=combobox aria-owns=jump-to-results aria-label="Search or jump to" aria-haspopup=listbox aria-expanded=false><div class=position-relative></div></div></div><nav class=d-flex aria-label=Global><a class="js-selected-navigation-item Header-link py-lg-3">&nbsp;</a></nav><div class="Header-item Header-item--full flex-justify-center d-lg-none position-relative" style=margin-right:auto><a class=Header-link href=https://a-castellano.github.io/ aria-label=Homepage data-ga-click="Header, go to dashboard, icon:logo"><svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div><div class="Header-item position-relative mr-0 d-none d-lg-flex"><details class="details-overlay details-reset"><summary class=Header-link aria-label="View profile and more" data-ga-click="Header, show menu, icon:avatar"><img alt class=avatar src="https://avatars0.githubusercontent.com/u/11519707?s=460&u=c9ea059a83c4ea6f9daddec4fff28b1afacbe85a&v=4" height=20 width=20></summary></details></div></header></div><div id=start-of-content class=show-on-focus></div><div id=js-flash-container></div><div class=application-main data-commit-hovercards-enabled><div itemscope itemtype=http://schema.org/SoftwareSourceCode><main><div class="pagehead repohead instapaper_ignore readability-menu experiment-repo-nav pt-0 pt-lg-4"><div class="repohead-details-container clearfix container-lg p-responsive d-none d-lg-block"><div class="mb-3 d-flex"><h1 class="public css-truncate float-none flex-auto width-fit pl-0"><a class="avatar mr-1" href=https://a-castellano.github.io/about/><img src="https://avatars0.githubusercontent.com/u/11519707?s=460&u=c9ea059a83c4ea6f9daddec4fff28b1afacbe85a&v=4" width=26 height=26></a>
<span class=author><a href=https://a-castellano.github.io/>Álvaro Castellano</a></span>
<span class=path-divider>/</span>
<strong itemprop=name class=css-truncate-target style=max-width:410px><a href=https://a-castellano.github.io/posts/deploying-vms-using-cloudinit/>Deploying VM's using Cloud-init</a></strong><div class="d-block text-small text-gray">Created <time-ago datetime=2020-05-31 class=no-wrap title="Created at 2020/05/31">2020-05-31</time-ago>
<span class=file-info-divider></span>Modifyed <time-ago datetime=2020-05-31 class=no-wrap title="Modified  at 2020/05/31">2020-05-31</time-ago></div></h1></div></div></div><div class="container-lg clearfix new-discussion-timeline experiment-repo-nav p-responsive"><div class=repository-content><div class="Box mt-3 position-relative"><div class="Box-header py-2 d-flex flex-column flex-shrink-0 flex-md-row flex-md-items-center"><div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">2273 Words</div></div><div id=readme class="Box-body readme blob instapaper_body js-code-block-container"><article class="markdown-body entry-content p-3 p-md-6" itemprop=text><h1 id=the-beginning---vm-templates>The beginning - VM templates</h1><p>Instead of having a server with multiple services installed, almost three years ago I started to use larger servers with KVM in order to manage multiple VM for those services. I had three &ldquo;template&rdquo; machines, for <em>Debian 9</em>, <em>Ubuntu 16.04</em> and <em>Ubuntu 18.04</em>. Each time I needed a new machine I followed the following steps:</p><ul><li>Clone the &ldquo;template&rdquo; VM.</li><li>Power on the new VM.</li><li>Reconfigure network config and DNS&rsquo;s in order to change VM network interface.</li><li>Reboot the machine.</li><li>Hope that I did not fail in any step.</li><li>Start working with the new VM.</li></ul><p>After 5-10 minutes my new VM was ready, great&mldr;.</p><p>Really? Well, let&rsquo;s face it, after two years doing this I&rsquo;ve got tired of deploying VM in that way.</p><p>Also, in order to save time for next VM deploys I often update those templates (basic tools and kernel). At the end I had another three VM&rsquo;s to manage.</p><h1 id=proxmox-clusters>Proxmox Clusters</h1><p>Since last year my server has been running out of free space disk. I decided to rent a new server and start using <a href=https://www.proxmox.com/en/>Proxmox</a> instead of managing raw KVM servers.</p><p>Cluster is working and it works great. Now let&rsquo;s create new VM&rsquo;s templates&mldr;. not again. I will end cloning VM&rsquo;s again. Let&rsquo;s try another way.</p><h1 id=cloud-init-maybe-this-is-the-way>Cloud-init, (maybe) this is the way</h1><p>What Cloud-init is? According with <a href=https://cloudinit.readthedocs.io/en/latest/>official documentation</a> Cloud-init is the industry standard multi-distribution method for cross-platform cloud instance initialization. It allows us to ensure certain configurations are present on boot time on our VM&rsquo;s such as some interesting things I&rsquo;m interested about:</p><ul><li>Network configuration</li><li>User management</li><li>Repository management</li></ul><p>Those three items would allow me getting rid of maintaining templates. So let&rsquo;s begin.</p><h2 id=cloud-images>Cloud images</h2><p>We need to stop using current Ubuntu server images and use (Ubuntu Cloud Images)[https://cloud-images.ubuntu.com/] which include Cloud-init configs. We will make changes in order to set Network configuration, users and repos.</p><p>Download latest Ubuntu Bionic Cloud image</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>wget -O /var/lib/vz/bionic.img https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img
</code></pre></div><p>In order to edit Cloud-init images we need to install libguestfs-tools</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>apt-get install libguestfs-tools
</code></pre></div><p>Now is time to edit Cloud-init config:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>virt-edit -a /var/lib/vz/bionic.img /etc/cloud/cloud.cfg
</code></pre></div><p>Let&rsquo;s review how I have changed the original file:</p><h2 id=cloud-init-levels>Cloud-init levels</h2><p>The following configuration will be the default one but it can be updated without changing this default configuration. We can add a Cloud-init device that can override this configuration. For example, we can change hostname or network config when creating new machine form our template.</p><h2 id=cloud-init-modules>Cloud-init modules</h2><p>Here are the modules that Cloud-init will load in order to make changes, here are only listed few of them, the ones I&rsquo;m using or u pretend to use in the near future.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#66d9ef>cloud_init_modules</span>:
 - write-files
 - growpart
 - resizefs
 - disk_setup
 - mounts
 - set_hostname
 - update_hostname
 - update_etc_hosts
 - ca-certs
 - users-groups
 - ssh

<span style=color:#66d9ef>cloud_config_modules</span>:
 - emit_upstart
 - locale
 - set-passwords
 - grub-dpkg
 - apt-pipelining
 - apt-configure
 - timezone
 - runcmd

<span style=color:#66d9ef>cloud_final_modules</span>:
 - package-update-upgrade-install
 - salt-minion
 - scripts-vendor
 - ssh-authkey-fingerprints
 - keys-to-console
 - final-message
</code></pre></div><h3 id=disable-root-and-preserve-hostname>Disable root and preserve hostname</h3><p>Root cannot log in directly in our server, also hostname can be altered by Cloud-init config.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#66d9ef>disable_root</span>: <span style=color:#66d9ef>true</span>

<span style=color:#66d9ef>preserve_hostname</span>: <span style=color:#66d9ef>false</span>
</code></pre></div><h3 id=ssh-public-keys>SSH public keys</h3><p>All created user will have the following ssh public keys authorized:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#66d9ef>ssh_authorized_keys</span>:
  - ssh-rsa MyPublicSSH Key
</code></pre></div><h3 id=user-config>User config</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>
<span style=color:#66d9ef>Our user **youruser** will be able to become root accrding with *sudo* given option</span>:

<span style=color:#66d9ef>system_info</span>:
   <span style=color:#75715e># This will affect which distro class gets used</span>
   <span style=color:#66d9ef>distro</span>: ubuntu
   <span style=color:#75715e># Default user name + that default users groups (if added/used)</span>
   <span style=color:#66d9ef>default_user</span>:
     <span style=color:#66d9ef>name</span>: youruser
     <span style=color:#66d9ef>lock_passwd</span>: True
     <span style=color:#66d9ef>gecos</span>: Youruser
     <span style=color:#66d9ef>groups</span>: [adm, audio, cdrom, dialout, dip, floppy, lxd, netdev, plugdev, sudo, video]
     <span style=color:#66d9ef>sudo</span>: [<span style=color:#e6db74>&#34;ALL=(ALL) NOPASSWD:ALL&#34;</span>]
     <span style=color:#66d9ef>shell</span>: /bin/bash
   <span style=color:#75715e># Automatically discover the best ntp_client</span>
   <span style=color:#66d9ef>ntp_client</span>: auto
   <span style=color:#75715e># Other config here will be given to the distro class and/or path classes</span>
   <span style=color:#66d9ef>paths</span>:
      <span style=color:#66d9ef>cloud_dir</span>: /var/lib/cloud/
      <span style=color:#66d9ef>templates_dir</span>: /etc/cloud/templates/
      <span style=color:#66d9ef>upstart_dir</span>: /etc/init/
   <span style=color:#66d9ef>ssh_svcname</span>: ssh

<span style=color:#66d9ef>password</span>: defauluerpassword
</code></pre></div><p>Wait, are you posting a clear text password in your Cloud-init confg? Why? Is it necessary?</p><p>Yes, password has to be in clear text. No, it isn&rsquo;t necessary. Why am I setting a password? Because sometimes accidents happen an machines lost internet connection, I would like to enter into my VM using hypervisor screen. Of course we will set a sshd config that disallows password authentication.ººº:w</p><h3 id=timezone-and-locale-config>Timezone and locale config</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#66d9ef>timezone</span>: <span style=color:#e6db74>&#34;Europe/Madrid&#34;</span>
<span style=color:#66d9ef>locale</span>: en_US
</code></pre></div><h3 id=ssh-config>SSH config</h3><p>Cloud-init allows us to place files in our system, let&rsquo;s change default sshd config. Only logging using ssh keys is allowed there is only one user allowed to connectCloud-init allows us to place files in our system, let&rsquo;s change default sshd config. Only logging using ssh keys is allowed there is only one user allowed to connect.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#66d9ef>write_files</span>:
- <span style=color:#66d9ef>content</span>: <span style=color:#e6db74>|
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>    Port 22</span>
    Protocol <span style=color:#ae81ff>2</span>
    <span style=color:#75715e># HostKeys for protocol version 2</span>
    HostKey /etc/ssh/ssh_host_rsa_key
    HostKey /etc/ssh/ssh_host_dsa_key
    HostKey /etc/ssh/ssh_host_ecdsa_key
    HostKey /etc/ssh/ssh_host_ed25519_key
    <span style=color:#75715e>#Privilege Separation is turned on for security</span>
    UsePrivilegeSeparation yes

    <span style=color:#75715e># Lifetime and size of ephemeral version 1 server key</span>
    KeyRegenerationInterval <span style=color:#ae81ff>3600</span>
    ServerKeyBits <span style=color:#ae81ff>1024</span>

    <span style=color:#75715e># Logging</span>
    SyslogFacility AUTH
    LogLevel INFO

    <span style=color:#75715e># Authentication:</span>
    LoginGraceTime <span style=color:#ae81ff>60</span>
    PermitRootLogin prohibit-password
    StrictModes yes
    PasswordAuthentication no
    PubkeyAuthentication yes
    RSAAuthentication yes
    PubkeyAuthentication yes

    AllowUsers youruser

    IgnoreRhosts yes
    RhostsRSAAuthentication no
    HostbasedAuthentication no

    PermitEmptyPasswords no

    ChallengeResponseAuthentication no

    X11DisplayOffset <span style=color:#ae81ff>10</span>
    PrintMotd no
    PrintLastLog yes
    TCPKeepAlive yes

    AcceptEnv LANG LC_*

    Subsystem sftp /usr/lib/openssh/sftp-server

    UsePAM yes

  <span style=color:#66d9ef>path</span>: /etc/ssh/sshd_config
  <span style=color:#66d9ef>owner</span>: root:root
  <span style=color:#66d9ef>permissions</span>: <span style=color:#e6db74>&#39;0644&#39;</span>
</code></pre></div><h3 id=apt-config>Apt config</h3><p>My VM&rsquo;s do not use official Ubuntu repository lists, they use two repos:</p><ul><li><strong>repo-bionic.windmaker.net</strong> which stores a replica of official Ubuntu packages.</li><li><strong>repo.daedalus-project.io</strong> which stores Daedalus Project packages and other packages like Percona releases.</li></ul><p>First, we need to disable all Ubuntu repos first using <em>disable_suites</em> directive. After that we set our repo URL&rsquo;s and their GPG keys.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#66d9ef>apt</span>:
  <span style=color:#66d9ef>disable_suites</span>: [updates, backports, security, proposed, release]

  <span style=color:#66d9ef>sources</span>:
    <span style=color:#66d9ef>repo-bionic.list</span>:
      <span style=color:#66d9ef>source</span>: <span style=color:#e6db74>&#34;deb http://repo-bionic.windmaker.net/ bionic main&#34;</span>
      <span style=color:#66d9ef>key</span>: <span style=color:#e6db74>|
</span><span style=color:#e6db74>        -----BEGIN PGP PUBLIC KEY BLOCK-----</span>

        mQGNBFsf464BDACpTuXB5TO1Xaca2UfI9JeO2PmYOSKtnM6Fm+xkhP/XwM1+NIOG
        guvw/+g3JVmUN6cMklVDhUgE46iVn7OccXIKYoKFRWLFRkPx7KGFdxA2bxQ/N6zt
        TyfxUyskRQPvDbbBX/ExGsVl/Y+1hPullJlvuXja6pUXIa/q0I+/WYu6rlnDlp6Y
        SuTVlGlQY2TJ7ActOsOAO+TxkLonn/NJRPmJUmZW8foWgPMDgIIj/f800os9iFjx
        89cykmHgDc3Lt/9YE/OTfvrirmqKdlatcb+S9zAJ00F9/w+30qh+Y9p/IzgbxF6j
        ebuW8Ag6zAlvNgQZmYigbeZJoUZtBd9cM5Tm5gQZRoyCy+Vf00dl2Acl2OZ84OGA
        L3zrkeb9Mz40/FazEZsMpr2TtVQmYKRY8NRGX8RULxaePtagDos2nb7Em/MAVyI5
        ar2/Zh0wYxbRhjvBfP0gn97lprov72Ce8F/GoP8K798t5b0RoHtXQdarBO+Z7KuC
        CbsIAXNA5Zl25gMAEQEAAbQ6w4FsdmFybyBDYXN0ZWxsYW5vIFZlbGEgPGFsdmFy
        by5jYXN0ZWxsYW5vLnZlbGFAZ21haWwuY29tPokB1AQTAQoAPhYhBH0JhQsOihgj
        KUwRwfiEJpJagjkJBQJbH+OuAhsDBQkDwmcABQsJCAcCBhUKCQgLAgQWAgMBAh4B
        AheAAAoJEPiEJpJagjkJzEUL/1IchCrksbt95ngsWpfBU9pP69xSlGoJwQKWBycy
        uShkHCtH5F6DNRYVfFNbvgPaH2vvZrtKNzZqGfhJbWRvR1owdF4XOz0tPHTcU3NY
        MJT0KfRh8rms8Ai/jDdb9OY2kReqddUAyLLjdfd0NC+g5DYF5zagliEpkxWYAi/<span style=color:#ae81ff>0</span>
        H6tpB0Rg25L0Iu/M/toIu6VSCZqVRTfggrPKWddaA/kGGmbHKyAsfLEXkwXIT2IK
        N7nXNJCGCWrgmWtCs/8VVofgqspOoyU8ZxfsKrvlA+yEi53iOuDcLOycw6uRpjX9
        F93T2Vvt0bjPq85cViABZHkwXXUbRwxD9GOLVmGD+e7S6Vbw04mJff3phZ6x/AIP
        iT8PZOUSbngvS1SnKOfK1dSvwkoeMhV1xn2NH7lJPQmMwh3o3AVLGidIRfkegduK
        iG49Byn7qVhQu/6jKEyWHS2lMw0uKa34MRRsYtqqreUCp2F/51vSrJxxIgLF2pM6
        df/QgV3fNq9tEuP0TE52OSPx6rkBjQRbH+OuAQwA4bcfEDVDLyywSREfFdLuK2+E
        7oPLTGVw6T4fKhsR47hSydOMXC7RhLXKIUjZX2IL1u0gNzVJQuCkbHkSxdr6rwsc
        IjIuWgkzLfSw5z1BzHjJbfxS32XhQdM4noFx7KvFjh2Umwz1SPWvcj4Az1uX0kbL
        gsK5eJQ1YBz2lMdhZKMLNMZSsNnHuxXg6EfpfUHDusiTBBdttO2kQjl3eC4wZaOc
        VPMYO2HjeWRaK9Vhvt8aF/PU0bijBZZ69ZSv/E9wjgFlgvPsvMA92WNCawnC0JwW
        kosL+qjbn43EldTZe+RWTbgzW/e9bvCOUpeWlHKl1pncccM0LPWAGZi/HKQUFIds
        AyfJLK4Vr0p1s9p6TghiF0RVlvwWdRHhfRTLjASrHuVbh+eth7LC6/ZHhRrVdZTa
        qfSYNfvW0nUH/uF9XBr21XWTn67i8KiVDuveAPebq+R+SwVidWpin3t9U6ykODxc
        2gjIL25nRvZuptb0hHIm5OCnW8yi5VO3TLKZQBWlABEBAAGJAbwEGAEKACYWIQR9
        CYULDooYIylMEcH4hCaSWoI5CQUCWx/jrgIbDAUJA8JnAAAKCRD4hCaSWoI5CbqJ
        C/oDT5G9HGBDkfxv35ohU8p/J2tnOBmhKGvCLfIsK068bW7F/zX+P72yEY6QwT+Y
        IPC2cnfwhJ31Pd8muYhn8b7MJwSNdR0nxA3ORmhjMYGlbq4jH32RLvU9Qk6JA+Oh
        Xyw9uglilp454BLqe3ew+PxerN8nZKvVTwlmfZmI15N7PG3DP18/P8r73EUR6+ud
        F27vELLmgoqShOYRvh+yLsOcxPQlV5eCY5rcu0avATtuFrYpy02jTk5/ABMaMr5V
        /RooRtH3L5iueM2fdg5JIgyQ1cILPbsW+v53OIthjHNfgdIXGQO3svzA8U1/5qJk
        oghFyg6SiG/<span style=color:#ae81ff>2</span>+bdo2ociPGMu9VH/0o3Z9+YRrKeNJIwe1rYeWH/L8qJQ3kjWFcpB
        OfY50O2FiL1O24M8nOH5Ub3bdCH8+kW4SRQsUCsbnSIQzPaDJyO6vJ5myHh8B6IY
        ffYSW0AkNsBCjlAysc0w3X/CeuW0yVGg4PQUWehVoBvob1/08DvGHiq285hBftoB
        Gb4=
        =Uzuz
        -----END PGP PUBLIC KEY BLOCK----<span style=color:#e6db74>-
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>    repo-daedalus-project.list:</span>
      <span style=color:#66d9ef>source</span>: <span style=color:#e6db74>&#34;deb [arch=amd64] http://repo.daedalus-project.io/ bionic main&#34;</span>
      <span style=color:#66d9ef>key</span>: <span style=color:#e6db74>|
</span><span style=color:#e6db74>        -----BEGIN PGP PUBLIC KEY BLOCK-----</span>

        mQGNBF5s0RQBDAC5CSssBQGpW/cm3T98YqjIbowMnw9AJ3En+Mbt+hX2BdBBAhEe
        +ReHCMiydJDcsm6pIHpMccGtnPykIS51yNv6syb4aFAagauTXrkXlxWQBoy6xPnK
        ULOZYcBOUR4m3Mmt2LfmbcoZJqRfNudTxRF/mpLYOVc1kj7nnj41RTIVERmRdBTd
        GPOGZxZufTeKmahVpyBywiKTqWZu3t7zFiO9CttyDcV6T0RJe4K+lOemutmDNZc3
        39kElv3SrxeTYt1NdEJuIkYsjE5agz<span style=color:#ae81ff>+2</span>+ARB70M0Cze/Q9mB/rKqznwZlXUorG4W
        JB32rCZ8BXWlTdGhC/jFHk8vNoNFfauk93n77brVuOzZOYKpLDvYw7Ve1AvGA1Vi
        zsjbF0rOCBoCln7gyf3/JBQbbPyaKtTytl+V/MlueTJ37ZkQ3Jrt98WLS0UfMi5F
        xo+MlkAzTpTjN9tZPz0hSBSXRBlPesz9X7fdG1nQhs/74Vf/PURhViknSw+w5sdM
        sTMFL7bAfcaS1O0AEQEAAbQfV2luZG1ha2VyIDxhZG1pbkB3aW5kbWFrZXIubmV0
        PokB1AQTAQoAPhYhBMb8c9m0kYHPT9BVPHSXEhkPd7wpBQJebNEUAhsDBQkDwmcA
        BQsJCAcCBhUKCQgLAgQWAgMBAh4BAheAAAoJEHSXEhkPd7wpFwsL/RbaThK7D/m4
        2HzpanBQF6qrA8Lj+lX/mSrCGDcLKLnrtu+YtU7rri5GC34GV0MkU98XbuBNIYaC
        5JylK59e1SR5sq/5CvuCgIgx8b0UzHtlgIngzY3Ij26rC8AmlnHxa9/jTtD6a4VC
        tp3YI+xtkpRciE6KLcg/p607zWwCpUpnXFgCsPf5U6XyvEEvrZu3argAenZHURwH
        ADitwUPQAQWK3ipSXRuVCynI3YDuWqZOVNj1plFKXbvvC5lRd49swmcqjweKkM56
        <span style=color:#ae81ff>1</span>+4dNi2GUVklsaFDTa8aQsj382fYw4N8hPeQspQJiBMhzds0xI0JjnoYLkoZfX/u
        NqIRl247dse5g2u4KUjel/IOAgb7lYc69zX0mH0gbijz7Na4Cfys3QH4A1Kqi771
        hTEQhg0TUMbAjteK8c738Os1aJbhiUa4+V4eIFhwD0fmhy6EB4b1rUNCywHPIfPX
        ARadTs5uLe9q5TGZyWaGFThIfMz5xa9owe2TsLtWlz3sIDPHNIMsErkBjQRebNEU
        AQwAuIadvP0HFGeqkJRRNscyPeggJv7aPURiRUwHduOotOn8EwhBUxwvZMI9aJ9D
        teY7vKsQSVwN4xf8edUM+Bn6FAefQgvDNKGKX4TQO2T0pV0yqoCNnSwzLRJvqi4z
        hzYI6k2/Tz0NCV7AJA39q1f94J0P4g6ZK0hzmFjacT/gdb0mbs3CYg9ZoKQnQ+af
        nXlcnLHqAyeNLnJbJNU36SbAsjdh58YhVcAxPwLkByxBONSIC7qY+JSmJ1ygbfZK
        QtPk3WkgldduC6uBSAYMQlBPXUjZJK+V3xZGM39/mvvyHyEQwIblnwcNvdSi3WI2
        SqNb644ue8EB6PW/69mIJb3RxX67pd0+tPcaXUG8GBQgR4y7kvxMgOCU8asXe0T/
        nslds6BD3KkPcGsnicziS322msmJ0h0LVR5QxdSP/96cjWrpmCqKaZ79sNDrYLb/
        C3gAzwyFFVnUrCgFHBQ8Rc6+mQ/6pXtq4ZovtcnjJSIsv3cJkVOALjVD2TNu0/N7
        VfUVABEBAAGJAbwEGAEKACYWIQTG/HPZtJGBz0/QVTx0lxIZD3e8KQUCXmzRFAIb
        DAUJA8JnAAAKCRB0lxIZD3e8KYrYC/<span style=color:#ae81ff>9</span>/GvKHGZ+uEYmdJq9CzqUVy5BZYQLsuIV4
        h7WbRKVjtCWP00STclSxEm6eEY8PzawiEC+AET0OAGE+krRRWgOzPNDnrL7IMi3n
        HR4Xj/FMUCCgCvNMBYjVPZyBqY5vwyr8Ta3yWf/eN+cxZzpXo/SOA4Pfenci4Am/
        9Y7pGQoOgAGIoPB2fmQg5ttyxr0GfBBaj0aE1aB7osICgQdPriC+Gu3aHWT6kUsz
        <span style=color:#ae81ff>8</span>+2zuIXsHD66aN+q5XxKamptOU80B7NVut+XhFrFa/Qit+IPJDfvxywSRWb6R<span style=color:#ae81ff>+65</span>
        u+SW8rcCq1AecbCRqO++vmkHS2QVWbDQtoJ6GEV6BRtHXWJmPaDdLulacvkKEcA<span style=color:#e6db74>+
</span><span style=color:#e6db74>        ZALHZKyvHG6HW/IhO4jcVQ5uh2RwjGyIE4Y7yJ6PZs+MkcISw438NapOT4CY8Bs4</span>
        aIiNytCfCfGOzvOgttxSyhGQhgVZz1lMogl7OoOOalLgTRUOsOzVg90Y8vgNR4g6
        eZiQKhRY1gf+exPCSjnji7snbdsSqX0=
        =FDFJ
        -----END PGP PUBLIC KEY BLOCK-----
</code></pre></div><p>Entire Cloud-init file can be found <a href=https://gist.github.com/a-castellano/49cee1dbf1f1e29c81d44536d98189a2>here</a>.</p><h2 id=creating-a-template-vm>Creating a template VM</h2><p>After editing our Cloud-init file, let&rsquo;s create a VM template using Proxmox.</p><p>The new template will be named <strong>bionicTmeplate</strong>. We will set a net card attached to our VM&rsquo;s network, in my case vmbr1. RAM is set to 2048Mb</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>qm create <span style=color:#ae81ff>100</span> --memory <span style=color:#ae81ff>2048</span> --net0 virtio,bridge<span style=color:#f92672>=</span>vmbr1 --name<span style=color:#f92672>=</span>bionicTmeplate
</code></pre></div><p>Import Ubuntu Bionic Cloud image:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>qm importdisk <span style=color:#ae81ff>100</span> /var/lib/vz/bionic.img local
</code></pre></div><p>Attach the new disk to our VM:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>qm set <span style=color:#ae81ff>100</span> --scsihw virtio-scsi-pci --virtio0 local:100/vm-100-disk-0.raw
</code></pre></div><p>We will need to add a cloudinit disk too:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>qm set <span style=color:#ae81ff>100</span> --ide2 local:cloudinit
</code></pre></div><p>Set first disk as bootable one:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>qm set <span style=color:#ae81ff>100</span> --boot c --bootdisk virtio0
</code></pre></div><p>Set the screen using a serial socket, this config will allow us to copy text from hipervisor screen:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>qm set <span style=color:#ae81ff>100</span> --serial0 socket --vga serial0
</code></pre></div><p>Finally, we create a template from this VM.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>qm template <span style=color:#ae81ff>100</span>
</code></pre></div><h2 id=creating-a-new-vm>Creating a new VM</h2><p>Time to create a new VM using this new template:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>qm clone <span style=color:#ae81ff>100</span> <span style=color:#ae81ff>123</span> --name Test
</code></pre></div><p>Let&rsquo;s resize disk before start the VM:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>qm resize <span style=color:#ae81ff>123</span> virtio0 +30G
</code></pre></div><p>Each VM must have its own IP address, we config it now:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>qm set <span style=color:#ae81ff>123</span> --ipconfig0 ip<span style=color:#f92672>=</span>10.XXX.YYY.10/16,gw<span style=color:#f92672>=</span>10.XXX.1.11
qm set <span style=color:#ae81ff>123</span> --nameserver 10.XXX.ZZZ.10
</code></pre></div><p>Time to start the VM, on startup we will see how our config is applied:</p><p>Our network config is applied:</p><pre><code>         Starting Initial cloud-init job (pre-networking)...
[   21.020495] cloud-init[593]: Cloud-init v. 19.4-33-gbb4131a2-0ubuntu1~18.04.1 running 'init-local' at Sun, 31 May 2020 17:49:26 +0000. Up 20.11 seconds.
[  OK  ] Started Initial cloud-init job (pre-networking).
[  OK  ] Reached target Network (Pre).
         Starting Network Service...
[  OK  ] Started Network Service.
         Starting Network Name Resolution...
         Starting Wait for Network to be Configured...
[  OK  ] Started Network Name Resolution.
[  OK  ] Reached target Host and Network Name Lookups.
[  OK  ] Reached target Network.
[  OK  ] Started Wait for Network to be Configured.
         Starting Initial cloud-init job (metadata service crawler)...
[   24.148124] cloud-init[701]: Cloud-init v. 19.4-33-gbb4131a2-0ubuntu1~18.04.1 running 'init' at Sun, 31 May 2020 17:49:30 +0000. Up 23.82 seconds.
[   24.158206] cloud-init[701]: ci-info: ++++++++++++++++++++++++++++++++++++++Net device info++++++++++++++++++++++++++++++++++++++
[   24.162608] cloud-init[701]: ci-info: +--------+------+------------------------------+-------------+--------+-------------------+
[   24.167279] cloud-init[701]: ci-info: | Device |  Up  |           Address            |     Mask    | Scope  |     Hw-Address    |
[   24.171305] cloud-init[701]: ci-info: +--------+------+------------------------------+-------------+--------+-------------------+
[   24.174399] cloud-init[701]: ci-info: | ens18  | True |        10.XXX.YYY.10         | 255.255.0.0 | global | ce:47:27:a4:12:cb |
[   24.177641] cloud-init[701]: ci-info: | ens18  | True | fe80::cc47:27ff:fea4:12cb/64 |      .      |  link  | ce:47:27:a4:12:cb |
[   24.180768] cloud-init[701]: ci-info: |   lo   | True |          127.0.0.1           |  255.0.0.0  |  host  |         .         |
[   24.184262] cloud-init[701]: ci-info: |   lo   | True |           ::1/128            |      .      |  host  |         .         |
[   24.189674] cloud-init[701]: ci-info: +--------+------+------------------------------+-------------+--------+-------------------+
[   24.194320] cloud-init[701]: ci-info: ++++++++++++++++++++++++++++Route IPv4 info++++++++++++++++++++++++++++
[   24.198817] cloud-init[701]: ci-info: +-------+-------------+-------------+-------------+-----------+-------+
[   24.202828] cloud-init[701]: ci-info: | Route | Destination |   Gateway   |   Genmask   | Interface | Flags |
[   24.206859] cloud-init[701]: ci-info: +-------+-------------+-------------+-------------+-----------+-------+
[   24.209845] cloud-init[701]: ci-info: |   0   |   0.0.0.0   | 10.XXX.1.11 |   0.0.0.0   |   ens18   |   UG  |
[   24.212480] cloud-init[701]: ci-info: |   1   |  10.XXX.0.0 |   0.0.0.0   | 255.255.0.0 |   ens18   |   U   |
[   24.215526] cloud-init[701]: ci-info: +-------+-------------+-------------+-------------+-----------+-------+
[   24.219341] cloud-init[701]: ci-info: +++++++++++++++++++Route IPv6 info+++++++++++++++++++
[   24.221671] cloud-init[701]: ci-info: +-------+-------------+---------+-----------+-------+
[   24.223971] cloud-init[701]: ci-info: | Route | Destination | Gateway | Interface | Flags |
[   24.227114] cloud-init[701]: ci-info: +-------+-------------+---------+-----------+-------+
[   24.230247] cloud-init[701]: ci-info: |   1   |  fe80::/64  |    ::   |   ens18   |   U   |
[   24.233530] cloud-init[701]: ci-info: |   3   |    local    |    ::   |   ens18   |   U   |
[   24.239004] cloud-init[701]: ci-info: |   4   |   ff00::/8  |    ::   |   ens18   |   U   |
[   24.242550] cloud-init[701]: ci-info: +-------+-------------+---------+-----------+-------+
</code></pre><p>Custom repos are added to VM&rsquo;s repo list:</p><pre><code>Test login: [   35.727835] cloud-init[1090]: Generating locales (this might take a while)...
[   36.341105] cloud-init[1090]:   en_US.ISO-8859-1... done
[   36.342903] cloud-init[1090]: Generation complete.
[   39.693040] cloud-init[1090]: Get:1 http://repo.daedalus-project.io bionic InRelease [5152 B]
[   39.762068] cloud-init[1090]: Get:2 http://repo-bionic.windmaker.net bionic InRelease [3000 B]
[   39.872322] cloud-init[1090]: Get:3 http://repo.daedalus-project.io bionic/main amd64 Packages [70.4 kB]
[   40.040415] cloud-init[1090]: Get:4 http://repo-bionic.windmaker.net bionic/main amd64 Packages [15.2 MB]
[   47.544781] cloud-init[1090]: Fetched 15.3 MB in 5s (2863 kB/s)
[   48.836633] cloud-init[1090]: Reading package lists...
[   48.938858] cloud-init[1090]: Cloud-init v. 19.4-33-gbb4131a2-0ubuntu1~18.04.1 running 'modules:config' at Sun, 31 May 2020 17:49:42 +0000. Up 35.45 seconds.
[   49.690566] cloud-init[1735]: Reading package lists...
[   49.854240] cloud-init[1735]: Building dependency tree...
[   49.857138] cloud-init[1735]: Reading state information...
[   49.951017] cloud-init[1735]: Calculating upgrade...
[   50.062925] cloud-init[1735]: The following package was automatically installed and is no longer required:
[   50.067178] cloud-init[1735]:   grub-pc-bin
[   50.069484] cloud-init[1735]: Use 'apt autoremove' to remove it.
[   50.116744] cloud-init[1735]: The following packages will be upgraded:
[   50.121606] cloud-init[1735]:   init init-system-helpers iproute2
[   50.158913] cloud-init[1735]: 3 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
[   50.161701] cloud-init[1735]: Need to get 812 kB of archives.
[   50.165186] cloud-init[1735]: After this operation, 285 kB of additional disk space will be used.
[   50.168542] cloud-init[1735]: Get:1 http://repo-bionic.windmaker.net bionic/main amd64 init-system-helpers all 1.56+nmu1~ubuntu18.04.1 [38.2 kB]
[   50.193411] cloud-init[1735]: Get:2 http://repo-bionic.windmaker.net bionic/main amd64 init amd64 1.56+nmu1~ubuntu18.04.1 [6040 B]
[   50.212301] cloud-init[1735]: Get:3 http://repo-bionic.windmaker.net bionic/main amd64 iproute2 amd64 4.18.0-1ubuntu2~ubuntu18.04.1 [768 kB]
</code></pre><p>Finally our public key is added to <strong>youruser</strong> authorized keys:</p><pre><code>[   54.253006] cloud-init[1735]: Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
ci-info: +++++++++++++++++Authorized keys from /home/ventus/.ssh/authorized_keys for user ventus+++++++++++++++++
ci-info: +---------+-------------------------------------------------+---------+--------------------------+
ci-info: | Keytype |                Fingerprint (md5)                | Options |         Comment          |
ci-info: +---------+-------------------------------------------------+---------+--------------------------+
ci-info: | ssh-rsa | 50:12:39:be:84:c1:f1:b6:89:6c:43:85:40:36:b1:f5 |    -    | yoursshid@yourhost.local |
ci-info: +---------+-------------------------------------------------+---------+--------------------------+
</code></pre><h2 id=testing-vm-access>Testing VM access</h2><p>Let&rsquo;s login into our VM and check all our configs are working:</p><pre><code>$ ssh ventus@10.XXX.YYY.10
Warning: Permanently added '10.XXX.YYY.10' (ECDSA) to the list of known hosts.
Welcome to Ubuntu 18.04.4 LTS (GNU/Linux 4.15.0-101-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Sun May 31 20:24:51 CEST 2020

  System load:  0.81              Processes:            84
  Usage of /:   3.4% of 31.04GB   Users logged in:      0
  Memory usage: 6%                IP address for ens18: 10.XXX.YYY.10
  Swap usage:   0%

0 packages can be updated.
0 updates are security updates.



The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

To run a command as administrator (user &quot;root&quot;), use &quot;sudo &lt;command&gt;&quot;.
See &quot;man sudo_root&quot; for details.

ventus@Test:~$ df -h
Filesystem      Size  Used Avail Use% Mounted on
udev            985M     0  985M   0% /dev
tmpfs           200M  616K  199M   1% /run
/dev/vda1        32G  1.1G   30G   4% /
tmpfs           997M     0  997M   0% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs           997M     0  997M   0% /sys/fs/cgroup
/dev/vda15      105M  3.6M  101M   4% /boot/efi
tmpfs           200M     0  200M   0% /run/user/1000
ventus@Test:~$ sudo su
root@Test:/home/ventus# ip add
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: ens18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 6e:38:1b:41:f6:7a brd ff:ff:ff:ff:ff:ff
    inet 10.XXX.YYY.10/16 brd 10.XXX.255.255 scope global ens18
       valid_lft forever preferred_lft forever
    inet6 fe80::6c38:1bff:fe41:f67a/64 scope link
       valid_lft forever preferred_lft forever
root@Test:/home/ventus# cat /etc/apt/sources.list.d/repo-bionic.list
deb http://repo-bionic.windmaker.net/ bionic main
root@Test:/home/ventus# cat /etc/apt/sources.list.d/repo-daedalus-project.list
deb [arch=amd64] http://repo.daedalus-project.io/ bionic main
</code></pre><h2 id=final-steps>Final steps</h2><p>After setting up the VM we should remove Cloud-Init device:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>qm set <span style=color:#ae81ff>123</span> --ide2 none
</code></pre></div></article></div></div></div></div></main></div></div><div class="footer container-lg width-full p-responsive" role=contentinfo><div class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light"><ul class="list-style-none d-flex flex-wrap col-12 col-lg-5 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0"><li class="mr-3 mr-lg-0"></a></li></ul><a aria-label=Homepage title="Álvaro Castellano - Personal Blog" class="footer-octicon d-none d-lg-block mx-lg-4" href=https://a-castellano.github.io/><svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" width="24" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><ul class="list-style-none d-flex flex-wrap col-12 col-lg-5 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0"></ul></div><div class="d-flex flex-justify-center pb-6"><span class="f6 text-gray-light"></span></div></div><script crossorigin=anonymous type=application/javascript src=https://a-castellano.github.io/js/frameworks.js></script><script crossorigin=anonymous type=application/javascript src=https://a-castellano.github.io/js/github-bootstrap.js></script><script src=https://a-castellano.github.io/js/stop.js></script><script src=https://a-castellano.github.io/js/contributions.js></script></body></html>